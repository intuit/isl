name: Publish to Maven Central (Snapshot/Release)

on:
  release:
    types: [created]
  push:
    branches: [ main, master ]
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to publish (e.g., 1.1.0)'
        required: false
        type: string

jobs:
  publish-snapshot:
    name: Publish Snapshot
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    # Run on pushes to main/master branches
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up JDK 21
      uses: actions/setup-java@v4
      with:
        java-version: '21'
        distribution: 'corretto'

    - name: Grant execute permission for gradlew
      run: chmod +x gradlew

    - name: Setup Gradle
      uses: gradle/actions/setup-gradle@v3
      with:
        gradle-version: wrapper

    - name: Verify OSSRH credentials
      env:
        MAVEN_CENTRAL_USERNAME: ${{ secrets.OSSRH_USERNAME }}
        MAVEN_CENTRAL_PASSWORD: ${{ secrets.OSSRH_PASSWORD }}
      run: |
        if [ -z "$MAVEN_CENTRAL_USERNAME" ]; then
          echo "❌ MAVEN_CENTRAL_USERNAME is not set!"
          exit 1
        fi
        if [ -z "$MAVEN_CENTRAL_PASSWORD" ]; then
          echo "❌ MAVEN_CENTRAL_PASSWORD is not set!"
          exit 1
        fi
        echo "✓ OSSRH credentials are configured"

    - name: Determine and update version
      id: version
      run: |
        # Read current version from gradle.properties
        CURRENT_VERSION=$(grep "^version=" gradle.properties | cut -d'=' -f2 | tr -d '\r')
        echo "Current version: $CURRENT_VERSION"

        # Automatic increment for snapshots
        if [[ "$CURRENT_VERSION" =~ ^([0-9]+)\.([0-9]+)\.([0-9]+)(-SNAPSHOT)?$ ]]; then
          MAJOR="${BASH_REMATCH[1]}"
          MINOR="${BASH_REMATCH[2]}"
          PATCH="${BASH_REMATCH[3]}"
          NEW_PATCH=$((PATCH + 1))
          NEW_VERSION="${MAJOR}.${MINOR}.${NEW_PATCH}-SNAPSHOT"
          echo "Incrementing patch version: $CURRENT_VERSION -> $NEW_VERSION"
        else
          echo "❌ Unable to parse version: $CURRENT_VERSION"
          exit 1
        fi

        # Update gradle.properties with new version
        sed -i "s/version=.*/version=$NEW_VERSION/" gradle.properties
        echo "Updated gradle.properties with version: $NEW_VERSION"

        # Output the new version for use in other steps
        echo "version=$NEW_VERSION" >> $GITHUB_OUTPUT

    - name: Build artifacts
      run: ./gradlew build --no-daemon --stacktrace -x test

    - name: Publish Snapshot to Maven Central
      env:
        MAVEN_CENTRAL_USERNAME: ${{ secrets.OSSRH_USERNAME }}
        MAVEN_CENTRAL_PASSWORD: ${{ secrets.OSSRH_PASSWORD }}
        ORG_GRADLE_PROJECT_mavenCentralUsername: ${{ secrets.OSSRH_USERNAME }}
        ORG_GRADLE_PROJECT_mavenCentralPassword: ${{ secrets.OSSRH_PASSWORD }}
      run: ./gradlew publishToMavenCentral --no-daemon --stacktrace --info

  publish-release:
    name: Publish Release to Maven Central
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    # Run on releases or manual dispatch
      
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up JDK 21
      uses: actions/setup-java@v4
      with:
        java-version: '21'
        distribution: 'corretto'
        
    - name: Grant execute permission for gradlew
      run: chmod +x gradlew
      
    - name: Setup Gradle
      uses: gradle/actions/setup-gradle@v3
      with:
        gradle-version: wrapper

    - name: Determine and update version
      id: version
      run: |
        # Read current version from gradle.properties
        CURRENT_VERSION=$(grep "^version=" gradle.properties | cut -d'=' -f2 | tr -d '\r')
        echo "Current version: $CURRENT_VERSION"

        if [ "${{ github.event.inputs.version }}" != "" ]; then
          # Manual version specified
          NEW_VERSION="${{ github.event.inputs.version }}"
          echo "Using manually specified version: $NEW_VERSION"
        elif [ "${{ github.event_name }}" = "release" ]; then
          # Release event - create release version (remove -SNAPSHOT if present)
          NEW_VERSION=$(echo "$CURRENT_VERSION" | sed 's/-SNAPSHOT$//')
          echo "Creating release version: $NEW_VERSION"
        else
          # Automatic increment for snapshots
          if [[ "$CURRENT_VERSION" =~ ^([0-9]+)\.([0-9]+)\.([0-9]+)(-SNAPSHOT)?$ ]]; then
            MAJOR="${BASH_REMATCH[1]}"
            MINOR="${BASH_REMATCH[2]}"
            PATCH="${BASH_REMATCH[3]}"
            NEW_PATCH=$((PATCH + 1))
            NEW_VERSION="${MAJOR}.${MINOR}.${NEW_PATCH}-SNAPSHOT"
            echo "Incrementing patch version: $CURRENT_VERSION -> $NEW_VERSION"
          else
            echo "❌ Unable to parse version: $CURRENT_VERSION"
            exit 1
          fi
        fi

        # Update gradle.properties with new version
        sed -i "s/version=.*/version=$NEW_VERSION/" gradle.properties
        echo "Updated gradle.properties with version: $NEW_VERSION"

        # Output the new version for use in other steps
        echo "version=$NEW_VERSION" >> $GITHUB_OUTPUT
        
    - name: Build artifacts
      run: ./gradlew build --no-daemon --stacktrace -x test
      
    # temp ignore to speed up the build
    # - name: Run tests
    #   run: ./gradlew test --no-daemon --stacktrace
    
    - name: Setup PGP key for signing
      run: |
        # Write the PGP key to environment variable
        # The key can be either base64-encoded or ASCII-armored
        if echo "${{ secrets.SIGNING_KEY }}" | grep -q "BEGIN PGP"; then
          # Key is already ASCII-armored
          echo "SIGNING_KEY<<EOF" >> $GITHUB_ENV
          echo "${{ secrets.SIGNING_KEY }}" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV
        else
          # Key is base64-encoded, decode it
          echo "${{ secrets.SIGNING_KEY }}" | tr -d '\n\r' | base64 --decode > signing_key.asc
          echo "SIGNING_KEY<<EOF" >> $GITHUB_ENV
          cat signing_key.asc >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV
          rm -f signing_key.asc
        fi

    - name: Publish to Maven Central
      env:
        MAVEN_CENTRAL_USERNAME: ${{ secrets.OSSRH_USERNAME }}
        MAVEN_CENTRAL_PASSWORD: ${{ secrets.OSSRH_PASSWORD }}
        # Gradle sets project properties from ORG_GRADLE_PROJECT_* (plugin build service reads these)
        ORG_GRADLE_PROJECT_mavenCentralUsername: ${{ secrets.OSSRH_USERNAME }}
        ORG_GRADLE_PROJECT_mavenCentralPassword: ${{ secrets.OSSRH_PASSWORD }}
        SIGNING_KEY: ${{ secrets.SIGNING_KEY }}
        SIGNING_PASSWORD: ${{ secrets.SIGNING_PASSWORD }}
      run: ./gradlew publishToMavenCentral --no-daemon --stacktrace --info

  publish-manual-snapshot:
    name: Publish Manual Snapshot
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    # Run on manual dispatch without version specified (snapshot publishing)
    if: github.event_name == 'workflow_dispatch' && github.event.inputs.version == ''

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up JDK 21
      uses: actions/setup-java@v4
      with:
        java-version: '21'
        distribution: 'corretto'

    - name: Grant execute permission for gradlew
      run: chmod +x gradlew

    - name: Setup Gradle
      uses: gradle/actions/setup-gradle@v3
      with:
        gradle-version: wrapper

    - name: Verify OSSRH credentials
      env:
        MAVEN_CENTRAL_USERNAME: ${{ secrets.OSSRH_USERNAME }}
        MAVEN_CENTRAL_PASSWORD: ${{ secrets.OSSRH_PASSWORD }}
      run: |
        if [ -z "$MAVEN_CENTRAL_USERNAME" ]; then
          echo "❌ MAVEN_CENTRAL_USERNAME is not set!"
          exit 1
        fi
        if [ -z "$MAVEN_CENTRAL_PASSWORD" ]; then
          echo "❌ MAVEN_CENTRAL_PASSWORD is not set!"
          exit 1
        fi
        echo "✓ OSSRH credentials are configured"

    - name: Determine and update version
      id: version
      run: |
        # Read current version from gradle.properties
        CURRENT_VERSION=$(grep "^version=" gradle.properties | cut -d'=' -f2 | tr -d '\r')
        echo "Current version: $CURRENT_VERSION"

        # Automatic increment for snapshots
        if [[ "$CURRENT_VERSION" =~ ^([0-9]+)\.([0-9]+)\.([0-9]+)(-SNAPSHOT)?$ ]]; then
          MAJOR="${BASH_REMATCH[1]}"
          MINOR="${BASH_REMATCH[2]}"
          PATCH="${BASH_REMATCH[3]}"
          NEW_PATCH=$((PATCH + 1))
          NEW_VERSION="${MAJOR}.${MINOR}.${NEW_PATCH}-SNAPSHOT"
          echo "Incrementing patch version: $CURRENT_VERSION -> $NEW_VERSION"
        else
          echo "❌ Unable to parse version: $CURRENT_VERSION"
          exit 1
        fi

        # Update gradle.properties with new version
        sed -i "s/version=.*/version=$NEW_VERSION/" gradle.properties
        echo "Updated gradle.properties with version: $NEW_VERSION"

        # Output the new version for use in other steps
        echo "version=$NEW_VERSION" >> $GITHUB_OUTPUT

    - name: Build artifacts
      run: ./gradlew build --no-daemon --stacktrace -x test

    - name: Publish Snapshot to Maven Central
      env:
        MAVEN_CENTRAL_USERNAME: ${{ secrets.OSSRH_USERNAME }}
        MAVEN_CENTRAL_PASSWORD: ${{ secrets.OSSRH_PASSWORD }}
        ORG_GRADLE_PROJECT_mavenCentralUsername: ${{ secrets.OSSRH_USERNAME }}
        ORG_GRADLE_PROJECT_mavenCentralPassword: ${{ secrets.OSSRH_PASSWORD }}
      run: ./gradlew publishToMavenCentral --no-daemon --stacktrace --info

